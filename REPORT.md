# Graph Cross: отчет о решении

В данном отчете описывается постановка задачи, реализация среды, процесс обучения LLM-агента с использованием reinforcement learning, а также анализ причин, по которым обучение не привело к росту качества.

Ноутбук с кодом обучения и логами доступен по ссылке:  
**https://drive.google.com/file/d/10a_xu-kM63V7H8R_BA2ThZVOeNO2uyhT/view?usp=sharing**

---

## Постановка задачи

<p align="center">
  <img src="https://i.imgur.com/OHAF88a.jpeg" width="500"/>
</p>

Задача представляет собой синтетическую логическую задачу на восстановление согласованной структуры, вдохновлённую кроссвордами, но не являющуюся кроссвордом в геометрическом смысле и не использующую семантику языка, словари или внешние знания.

Формально задача сводится к работе с графом взаимосвязей между строками. Любой классический кроссворд может быть представлен в таком виде (как набор строк и их пересечений), однако обратное неверно: получающаяся структура не обязана быть реализуемой как геометрическая сетка.

Все “слова” в задаче — это бессмысленные строки из случайных символов. Задача не требует знания значений слов или языковых закономерностей и сводится исключительно к выполнению формальных ограничений согласованности между элементами структуры.

---

## Описание задачи

- Задан набор **слотов** — абстрактных строк фиксированной длины.
- Каждый слот описывается следующими параметрами:
  - длина строки;
  - множество допустимых кандидатных строк.
- Между слотами задан набор **пересечений**.  
  Каждое пересечение задаётся явно как пара:
  - слот A, позиция *i*;
  - слот B, позиция *j*;
  и означает требование равенства символов:  
  `A[i] == B[j]`.
- Пересечения образуют граф связей между слотами; структура графа произвольна и не предполагает наличия координатной сетки.
- Для каждого слота модели предоставляется множество кандидатных строк, из которых необходимо выбрать ровно одну строку.

---

## Цель

Требуется выбрать по одной строке для каждого слота так, чтобы одновременно выполнялись следующие условия:

1. Длина выбранной строки совпадает с длиной соответствующего слота.
2. Выбранная строка принадлежит заданному для этого слота множеству кандидатов.
3. Для любого заданного пересечения двух слотов символы выбранных строк в соответствующих позициях совпадают.
4. Все выбранные строки совместимы между собой и образуют глобально согласованное решение.

---

## Сложность задачи

Сложность задачи регулируется следующими параметрами:

- количеством слотов;
- плотностью пересечений между слотами (структурой графа);
- количеством кандидатных строк на слот;
- числом строк-дистракторов каждого типа.

### Дистракторы

- строки правильной длины, но конфликтующие с другими слотами в одной или нескольких позициях пересечения (тип 0);
- строки, которые согласуются с частью пересечений, но нарушают другие (тип 1);
- строки, которые локально допустимы для конкретного слота, но делают невозможным глобальное согласование всей структуры (тип 2).

Наличие дистракторов исключает возможность решения задачи с помощью жадного выбора локально подходящих вариантов и требует проверки глобальной совместимости всех выбранных строк.

---

## Соответствие требованиям задания

- **Ответ верифицируем.**  
  Корректность решения проверяется автоматически: каждая выбранная строка должна принадлежать соответствующему множеству кандидатов, иметь корректную длину, а все заданные пересечения — удовлетворяться.

- **Сложность задачи регулируема.**  
  Сложность контролируется количественными параметрами генерации без изменения формулировки правил.

- **Задача решается за один запрос.**  
  Вся информация о слотах, кандидатах и пересечениях предоставляется модели в одном промпте; пошаговое взаимодействие со средой не требуется.

---

### Пример промпта, получаемого моделью

```text
You are given a set of string slots with fixed lengths and explicit intersection constraints.
Each intersection constraint enforces character equality between two slots at given indices.

Rules:
1) Choose exactly ONE candidate string for each slot.
2) The chosen string must be from that slot's candidate list.
3) All indices are 0-based.
4) All intersection constraints must hold simultaneously.
5) There is exactly ONE globally correct assignment.

Output format (STRICT):
- Your entire response MUST follow the system format with <reasoning> and <answer>.
- Inside <answer>, output ONLY a valid JSON object mapping slot_id -> chosen_string.
- Do NOT include markdown, code fences, or extra text inside <answer>.

Slots:
- S0: length=12, candidates=['mazoagkylozw', 'seqmkqjvtarw']
- S1: length=13, candidates=['vsstyroakijrz', 'tnrajbcmywwvd']
- S2: length=13, candidates=['iviwwvfgkywxo', 'veagjedshpjfh']
- S3: length=11, candidates=['rskjjudqrpv', 'eigmqlljjrf']
- S4: length=11, candidates=['fsdsdjemzwn', 'chokbmvbbxq']

Intersections (0-based indices):
- S0[10] == S1[12]
- S2[6] == S4[0]
- S1[9] == S2[0]
- S0[9] == S2[12]
- S1[1] == S3[1]
```

## Соответствие значений гиперпараметров уровням сложности

| Difficulty | #Slots | Avg. Intersections / Slot | Candidates / Slot | Distractors (d0 / d1) per slot / d2 |
|-----------:|-------:|---------------------------:|-------------------:|------------------------------------|
| 1 | 5  | 1.0 – 1.4 | 3 – 4  | 1 / 0 / 0 |
| 2 | 6  | 1.2 – 1.6 | 4 – 5  | 2 / 0 / 0 |
| 3 | 7  | 1.4 – 1.8 | 5 – 6  | 2 / 1 / 0 |
| 4 | 8  | 1.6 – 2.0 | 6 – 7  | 3 / 1 / 0 |
| 5 | 9  | 2.0 – 2.4 | 7 – 8  | 3 / 2 / 1 |
| 6 | 10 | 2.2 – 2.7 | 8 – 10 | 4 / 2 / 1–2 |
| 7 | 12 | 2.6 – 3.2 | 10 – 12 | 4 / 3 / 2 |
| 8 | 13 | 3.0 – 3.6 | 12 – 14 | 5 / 3 / 2–3 |
| 9 | 14 | 3.2 – 3.9 | 14 – 16 | 5 / 4 / 3–4 |
| 10 | 15 | 3.5 – 4.2 | 16 – 20 | 6 / 5 / 4–6 |

Дистракторы типа 2 задаются на уровне всего графа, так как являются структурными.

---

## Первая попытка обучения

Ниже приведён фрагмент логов обучения на исходной конфигурации сложности:

| Step | Training Loss | Reward | Reward Std | Mean Length | Min Length | Max Length | Clipped Ratio | Mean Terminated Length | Min Terminated Length | Max Terminated Length | KL       | Correctness Reward Mean | Correctness Reward Std |
|------|---------------|--------|------------|-------------|------------|------------|---------------|------------------------|-----------------------|-----------------------|----------|--------------------------|-------------------------|
| 10   | 0.000000      | 0.060000 | 0.005657 | 333.700000 | 232.200000 | 426.200000 | 0.175000 | 299.358334 | 232.200000 | 367.300000 | 0.000024 | 0.060000 | 0.014600 |
| 20   | 0.000000      | 0.064000 | 0.008485 | 292.825000 | 188.300000 | 400.100000 | 0.125000 | 263.441669 | 188.300000 | 335.500000 | 0.000023 | 0.064000 | 0.012000 |
| 30   | 0.000000      | 0.057250 | 0.009546 | 296.500000 | 189.600000 | 450.500000 | 0.175000 | 245.558336 | 189.600000 | 332.500000 | 0.000062 | 0.057250 | 0.017455 |
| 40   | 0.000000      | 0.065000 | 0.007071 | 317.125000 | 189.100000 | 446.700000 | 0.050000 | 307.908337 | 189.100000 | 425.800000 | 0.000355 | 0.065000 | 0.010000 |
| ...  | ...           | ...      | ...        | ...         | ...        | ...        | ...           | ...                    | ...                   | ...                   | ...      | ...                      | ...                     |
| 410  | 0.000100      | 0.070000 | 0.000000 | 192.575000 | 159.700000 | 241.600000 | 0.000000 | 192.575000 | 159.700000 | 241.600000 | 0.056191 | 0.070000 | 0.000000 |
| 420  | 0.000100      | 0.070000 | 0.000000 | 201.100000 | 161.200000 | 253.800000 | 0.000000 | 201.100000 | 161.200000 | 253.800000 | 0.057479 | 0.070000 | 0.000000 |
| 430  | 0.000100      | 0.068250 | 0.002475 | 213.375000 | 152.100000 | 306.900000 | 0.025000 | 206.733334 | 152.100000 | 297.200000 | 0.055281 | 0.068250 | 0.003500 |
| 440  | 0.000100      | 0.070000 | 0.000000 | 185.425000 | 146.800000 | 218.200000 | 0.000000 | 185.425000 | 146.800000 | 218.200000 | 0.065882 | 0.070000 | 0.000000 |
| 450  | 0.000000      | 0.070000 | 0.000000 | 199.575000 | 165.400000 | 245.500000 | 0.000000 | 199.575000 | 165.400000 | 245.500000 | 0.047632 | 0.070000 | 0.000000 |
| 460  | 0.000100      | 0.070000 | 0.000000 | 218.675000 | 156.400000 | 299.900000 | 0.000000 | 218.675000 | 156.400000 | 299.900000 | 0.064031 | 0.070000 | 0.000000 |


Из логов видно, что обучение не демонстрирует положительной динамики. Reward остаётся на уровне шума и не показывает тенденции к росту. Даже при минимальной сложности вероятность случайно получить корректную расстановку остаётся крайне низкой (порядка 0.0039).

---

## Пересмотр подхода и новая шкала сложности

Для упрощения задачи и попытки стабилизировать обучение был предложен двухэтапный подход с пересмотренной шкалой сложности.

| Difficulty | #Slots | Avg. Intersections / Slot | Candidates / Slot | Distractors (d0 / d1 / d2) | Назначение уровня |
|-----------:|-------:|--------------------------:|------------------:|---------------------------:|------------------|
| 0 | 3–4 | 1.5–2.0 | 2 | 0 / 0 / 0 | Warm-up: формат и базовая согласованность |
| 1 | 4–5 | 1.8–2.2 | 2–3 | 0 / 0 / 0 | Constraint propagation |
| 2 | 5–6 | 2.0–2.5 | 3 | 1 / 0 / 0 | Первый локальный конфликт |
| 3 | 6–7 | 2.2–2.8 | 3–4 | 1 / 1 / 0 | Частичная глобальность |
| 4 | 7–8 | 2.5–3.0 | 4 | 2 / 1 / 0 | Конфликты без поиска |
| 5 | 8–9 | 2.8–3.3 | 4–5 | 2 / 2 / 1 | Первый обязательный backtracking |
| 6 | 9–10 | 3.0–3.6 | 5–6 | 3 / 2 / 1–2 | Глобальные ловушки |
| 7 | 11–12 | 3.3–3.9 | 6–7 | 3 / 3 / 2 | Hard CSP |
| 8 | 12–13 | 3.6–4.2 | 7–8 | 4 / 3 / 2–3 | Very hard |
| 9 | 14 | 4.0–4.6 | 9–10 | 4 / 4 / 3–4 | Extreme |
| 10 | 15 | 4.5–5.2 | 10–12 | 5 / 5 / 4–6 | Stress test |

---

## Результаты первого этапа обучения

Фрагмент логов после упрощения конфигурации:

| Step | Training Loss | Reward | Reward Std | Mean Length | Min Length | Max Length | Clipped Ratio | Mean Terminated Length | Min Terminated Length | Max Terminated Length | KL       | Correctness Reward Mean | Correctness Reward Std |
|------|---------------|--------|------------|-------------|------------|------------|---------------|------------------------|-----------------------|-----------------------|----------|--------------------------|-------------------------|
| 10   | 0.000000 | 0.054000 | 0.022627 | 358.775000 | 197.400000 | 491.000000 | 0.275000 | 298.416672 | 197.400000 | 415.200000 | 0.000017 | 0.054000 | 0.024487 |
| 20   | 0.000000 | 0.038500 | 0.020506 | 414.200000 | 279.900000 | 505.800000 | 0.475000 | 297.500003 | 228.700000 | 357.200000 | 0.000023 | 0.038500 | 0.027759 |
| 30   | 0.000000 | 0.046500 | 0.016263 | 359.275000 | 192.700000 | 477.200000 | 0.350000 | 275.700003 | 192.700000 | 357.700000 | 0.000280 | 0.046500 | 0.024481 |
| 40   | 0.000000 | 0.053750 | 0.018031 | 326.050000 | 161.800000 | 490.400000 | 0.250000 | 267.441670 | 161.800000 | 389.900000 | 0.001160 | 0.053750 | 0.024709 |
| 50   | 0.000000 | 0.063500 | 0.009192 | 217.075000 | 113.700000 | 363.900000 | 0.100000 | 185.041669 | 113.700000 | 278.500000 | 0.006146 | 0.063500 | 0.013000 |
| 60   | 0.000000 | 0.070000 | 0.000000 | 161.675000 | 113.200000 | 253.500000 | 0.000000 | 161.675000 | 113.200000 | 253.500000 | 0.009525 | 0.070000 | 0.000000 |
| —    | 0.000000 | 0.070000 | 0.000000 | 143.400000 | 103.300000 | 214.300000 | 0.000000 | 143.400000 | 103.300000 | 214.300000 | 0.021478 | 0.070000 | 0.000000 |
| 560  | 0.000000 | 0.070000 | 0.000000 | 136.075000 | 105.800000 | 183.400000 | 0.000000 | 136.075000 | 105.800000 | 183.400000 | 0.025685 | 0.070000 | 0.000000 |
| 570  | 0.000000 | 0.070000 | 0.000000 | 138.975000 | 102.000000 | 186.600000 | 0.000000 | 138.975000 | 102.000000 | 186.600000 | 0.022484 | 0.070000 | 0.000000 |
| 580  | 0.000000 | 0.070000 | 0.000000 | 132.575000 | 102.200000 | 180.900000 | 0.000000 | 132.575000 | 102.200000 | 180.900000 | 0.020864 | 0.070000 | 0.000000 |
| 590  | 0.000000 | 0.070000 | 0.000000 | 138.250000 | 111.200000 | 182.600000 | 0.000000 | 138.250000 | 111.200000 | 182.600000 | 0.016468 | 0.070000 | 0.000000 |
| 600  | 0.000000 | 0.070000 | 0.000000 | 149.500000 | 111.200000 | 221.900000 | 0.025000 | 139.816667 | 111.200000 | 184.500000 | 0.017494 | 0.070000 | 0.000000 |


Несмотря на упрощение задачи, модель по-прежнему не получает устойчивого обучающего сигнала на train-выборке.

---

## Evaluation

Этап evaluation осознанно опущен. Поскольку модель не демонстрирует прогресса даже на обучающей выборке в максимально упрощённой конфигурации, оценка на отложенных данных не дала бы дополнительной информации.

---

## Анализ и выводы

<p align="center">
  <img src="https://preview.redd.it/pi38ojxhy3801.png?auto=webp&s=9da1f554e316d41251505a76412e5b2d92aec33d" width="300"/>
  <br/>
  <em>Figure X: Illustration of reinforcement learning dynamics under sparse binary reward.</em>
</p>

Вероятной причиной того, что модель не смогла обучиться даже на максимально упрощённой версии обучающей выборки, является сочетание разреженного бинарного вознаграждения и крайне негладкой, условно «игольчатой», поверхности ожидаемой награды. В таких условиях вероятность случайно получить корректное решение остаётся крайне низкой, из-за чего модель практически не получает обучающего сигнала.

В задачах GSM8K, использованных в референсном ноутбуке, аналогичная модель демонстрирует обучение при бинарном reward, что, вероятно, связано с наличием сильных априорных знаний. Модель уже на этапе претрейна усваивает семантические и арифметические паттерны, которые структурируют пространство решений и позволяют постепенно приближаться к правильному ответу. Кроме того, сами текстовые условия таких задач содержат семантическую информацию, делающую пространство допустимых продолжений более информативным.

Задача Graph Cross, напротив, намеренно лишена языковой и семантической структуры. Кандидатные строки являются случайными, а ограничения задаются исключительно формальными индексными равенствами. В результате корректные решения оказываются изолированными точками в пространстве возможных ответов и не образуют плавного перехода от частично корректных конфигураций к полностью согласованному решению. В таких условиях методы policy gradient не получают информативного направления для обновления политики.
